<html>
	<meta>
		<link href="/weather/style/bootstrap.css" rel="stylesheet">
		<link href="/weather/style/jquery-ui-1.10.4.custom.min.css" rel="stylesheet">
	  	<script src="/weather/javascript/jquery-1.10.2.js"></script>
	  	<script src="/weather/javascript/jquery-ui-1.10.4.custom.min.js"></script>
	  	<script src="/weather/javascript/moment.min.js"></script>
		<script type="text/javascript" src="/weather/googlemaps">
		</script>	  	
	  	<style type="text/css">
			.ui-autocomplete-loading { background:url('/weather/images/ui-anim_basic_16x16.gif') no-repeat right center }
	  	</style>
		<script type="text/javascript">

			function getmap(lat, lon, city) {
			    var myLatlng = new google.maps.LatLng(lat,lon);
			    var mapOptions = {
			      center: myLatlng,
			      zoom: 8
			    };
			    var map = new google.maps.Map($("#map-canvas")[0],
			      mapOptions);
			    var marker = new google.maps.Marker({
				  position: myLatlng,
				  map: map,
				  title: city
				});
			  }

			function initializeRequiredFields(){
				$( ":text" ).each(function(){
					$(this).css({border: "1px solid #cccccc"});
				});
			}

			function loaded(){
				$( "#loading" ).hide();
			}
			function loading(){
				$('#response').html("");
				$('#map-canvas').html("");
				$( "#loading" ).show(); 
			}

			$(function(){
				$.ajaxSetup({ scriptCharset: "utf-8" , contentType: "application/json; charset=utf-8"});
				loaded();

				$('#send').click(function(){  
					$('#response').html("");
					$('#map-canvas').html("");
					var data = {};
					data.city = $("#city").val();
					//alert(JSON.stringify(data));
					var requiredFieldFound = false;
					$( ":text" ).each(function(){
						if( $(this).val() == "" ){
							requiredFieldFound = true;
							$(this).css({border: "1px red solid"});
							setTimeout( function(){initializeRequiredFields()}, 2000 );
						}
					});
					if(requiredFieldFound){
						return false;
					}
					loading();

					$.ajax({ 
					   url: '/weather/forecast',
					   type: 'POST',
					   cache: false, 
					   data: JSON.stringify(data), 
					   contentType: "application/json",
					   success: function(data){
					      //console.log(data);
					      $('#response').html(data);
					      loaded();
					   }, 
					   error: function(jqXHR, textStatus, err){
					   	   loaded();
					   	   console.error('Error: status [%d], message [%s]', jqXHR.status, jqXHR.responseText);
					   	   $('#response').html(jqXHR.responseText);
						   $('#map-canvas').css("background-color", "");
					   }
					})
				});

				$("#city").focus(function(){
					this.select();		
				});


				$("#city").autocomplete({
					source: function (request, response){
						//console.log(request);
						data = {};
						data.city = request.term;
						$.ajax({
					          url: "/weather/city/list",
						   	  type: 'POST',
					          data: JSON.stringify(data),
					          success: function( data ) {
					            response( $.map( data.cities, function( item ) {
					            	//console.log("item: " + item);
					              return {
					                label: item,
					                value: item
					              }
					            }));
					          }
						});
					},
					minLength:3,
					select: function (event, ui) {
						 var selectedObj = ui.item;
						 jQuery("#city").val(selectedObj.value);
						 return false;
					}
				}).removeClass("ui-corner-all").addClass("ui-corner-top");
				$("#city").autocomplete("option", "delay", 100);
			});  			 		
		</script>
	</meta>
	<body>
		<form name="form" method="get" onsubmit="return false;">
			<label for="city"><h2>City</h2></label>
			<p><input type="text" name="city" id="city"/></p>
			<p><button name="button" id="send">Send</button></p>
		</form>
		<img id="loading" src="/weather/images/loading.gif" alt="">
		<div id="response"></div>
		<div id="map-canvas" style="width:400px; height:300px;"></div>
	</body>
</html>